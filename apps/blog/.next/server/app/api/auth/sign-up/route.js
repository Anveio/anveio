"use strict";(()=>{var e={};e.id=6383,e.ids=[6383],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50852:e=>{e.exports=require("async_hooks")},6113:e=>{e.exports=require("crypto")},6005:e=>{e.exports=require("node:crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},71248:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>W,originalPathname:()=>U,requestAsyncStorage:()=>$,routeModule:()=>H,serverHooks:()=>O,staticGenerationAsyncStorage:()=>D,staticGenerationBailout:()=>M});var r={};a.r(r),a.d(r,{POST:()=>POST}),a(44388);var s=a(15789),i=a(74902),o=a(46251),n=a(66355),l=a(66412),c=a(25620),d=a(118),u=a(79447),m=a(46991),p=a(47927),x=a(56304),h=a(32872),w=a(21698),g=a(838),f=a(54226),b=a(19026),y=a(36928),j=a(51689),v=a(41076),_=a(76076),k=a(99806),N=a(73867);let P=N.z.string({required_error:"RESEND_KEY missing. Required to send emails"}).parse(process.env.RESEND_KEY),E=new k.R(P),A="https://anveio.com",EmailTemplate=({destinationEmailAddress:e,verificationToken:t})=>{let a=new URL(`${A}/api/auth/verify-email?token=${t}&email=${e}`).href;return(0,c.jsxs)(d.V,{children:[c.jsx(u.F,{}),c.jsx(m.M,{children:"Confirm your email address to get started with Webm."}),c.jsx(p.L,{children:c.jsx(x.u,{className:"bg-white my-auto mx-auto font-sans",children:(0,c.jsxs)(h.W,{className:"border border-solid border-[#eaeaea] rounded my-[40px] mx-auto p-[20px] w-[465px]",children:[c.jsx(w.$,{className:"mt-[32px]",children:c.jsx(g.E,{src:`${A}/vercel.svg`,width:"40",height:"37",alt:"",className:"my-0 mx-auto"})}),(0,c.jsxs)(f.X,{className:"text-black text-[24px] font-normal text-center p-0 my-[30px] mx-0",children:["Confirm this email address for ",c.jsx("strong",{children:"Webm"})]}),c.jsx(b.x,{className:"text-black text-[14px] leading-[24px]",children:"Hello,"}),c.jsx(b.x,{className:"text-black text-[14px] leading-[24px]",children:"Click the button below to confirm your email address for Webm. Doing so will allow you to upload more"}),c.jsx(w.$,{className:"text-center mt-[32px] mb-[32px]",children:c.jsx(y.z,{style:{padding:"12px 20px"},className:"bg-[#000000] rounded text-white text-[12px] font-semibold no-underline text-center",href:a,children:"Confirm email"})}),(0,c.jsxs)(b.x,{className:"text-black text-[14px] leading-[24px]",children:["or copy and paste this URL into your browser:"," ",c.jsx(j.r,{href:a,className:"text-blue-600 no-underline",children:a})]}),c.jsx(v.Hr,{className:"border border-solid border-[#eaeaea] my-[26px] mx-0 w-full"}),c.jsx(b.x,{className:"text-[#666666] text-[12px] leading-[24px]",children:"If you were not expecting this invitation, you can ignore this email. If you are concerned about your account's safety, please reply to this email to get in touch with us."})]})})})]})},sendAccountVerificationEmail=async({destinationEmailAddress:e,verificationToken:t})=>{console.log(`Sending email to ${e}`);let a=await (0,_.j)(EmailTemplate({destinationEmailAddress:e,verificationToken:t}));return E.emails.send({from:"Anveio <welcome@webm.anveio.com>",to:[e],subject:"Confirm your email for Webm",html:a,tags:[{name:"category",value:"confirm_email"}]})};var S=a(42078),q=a(33925),R=a(60620),z=a(70914);let T=N.z.object({email:N.z.string().email(),password:N.z.string()}),C=N.z.object({email:N.z.string().email(),passwordHash:N.z.string(),publicId:N.z.string()});async function POST(e){let t=await e.json().catch(e=>{});if(void 0==t)return z.Z.json({},{status:400});let a=t.email,r=t.password,s=T.safeParse({email:a,password:r});if(!s.success)return z.Z.json({error:s.error},{status:400});let i=await (0,o.c)(s.data.password),n=(0,R.x0)(12),l=C.parse({email:a,passwordHash:i,publicId:n}),c=await (0,S.k)();try{return await createUser(l,c),await sendAccountVerificationEmail({destinationEmailAddress:s.data.email,verificationToken:c}),z.Z.json({publicId:n},{status:200})}catch(e){if(/AlreadyExists|Duplicate/i.test(e?.body?.message))return console.warn(`User already exists: ${s.data.email}`),console.warn(e),z.Z.json({},{status:200});return console.error(e),z.Z.json({},{status:500})}}let createUser=(e,t)=>{let a=C.parse(e);return n.db.transaction(async r=>{let s=await r.insert(l.rC).values(a).execute(),i=new Date,o=(0,q.Z)(i,365);return r.insert(l.Mc).values({userId:Number(s.insertId),email:e.email,token:t,expiresAt:o})})},H=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/sign-up/route",pathname:"/api/auth/sign-up",filename:"route",bundlePath:"app/api/auth/sign-up/route"},resolvedPagePath:"/home/shovonh/workspaces/anveio/apps/blog/src/app/api/auth/sign-up/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:$,staticGenerationAsyncStorage:D,serverHooks:O,headerHooks:W,staticGenerationBailout:M}=H,U="/api/auth/sign-up/route"},46251:(e,t,a)=>{a.d(t,{j:()=>doesPasswordMatchHash,c:()=>hashPassword});let r=require("argon2"),s=process.env.PASSWORD_SALT;if(!s)throw Error("PASSWORD_SALT is not defined");let hashPassword=e=>(0,r.hash)(e,{salt:Buffer.from(s)}),doesPasswordMatchHash=async(e,t)=>(0,r.verify)(e,t)}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[7534,3369,3077,3867,2828,1861,914,620,8960,9654],()=>__webpack_exec__(71248));module.exports=a})();